<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suporte Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* AnimaÃ§Ãµes de transiÃ§Ã£o */
        .slide-in { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* UtilitÃ¡rio para esconder completamente */
        .hidden-force { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col justify-center items-center relative overflow-hidden">

    <div class="absolute inset-0 z-0 opacity-10 pointer-events-none" style="background-image: url('https://img.freepik.com/free-photo/fiber-optic-cables-network_23-2148967339.jpg'); background-size: cover;"></div>
    <div class="z-10 text-center mb-10">
        <h1 class="text-4xl font-bold text-gray-800">Internet Ultra Veloz</h1>
        <p class="text-gray-600">SimulaÃ§Ã£o Site Provedor</p>
    </div>

    <div class="fixed bottom-6 right-6 z-50 flex flex-col items-end">
        
        <div id="chat-window" class="bg-white w-80 md:w-96 rounded-2xl shadow-2xl overflow-hidden border border-gray-200 mb-4 flex flex-col h-[500px] relative">
            
            <div class="bg-blue-600 p-4 flex justify-between items-center shrink-0 z-20 shadow-md">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-white">
                            <i class="fa-solid fa-headset"></i>
                        </div>
                        <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-400 border-2 border-blue-600 rounded-full"></span>
                    </div>
                    <div>
                        <h3 class="text-white font-bold text-sm">Suporte AliDash</h3>
                        <p class="text-blue-100 text-[10px]">Atendentes Online</p>
                    </div>
                </div>
                <button onclick="toggleChat()" class="text-white hover:text-gray-200"><i class="fa-solid fa-times"></i></button>
            </div>

            <div class="flex-1 relative bg-gray-50 overflow-hidden">

                {% if step == 1 %}
                <div id="screen-login" class="absolute inset-0 p-6 flex flex-col justify-center fade-in">
                    <div class="text-center">
                        <h2 class="text-gray-800 font-bold mb-2">Bem-vindo!</h2>
                        <p class="text-gray-500 text-xs mb-6">Para agilizar seu atendimento, digite seu CPF.</p>
                        
                        {% if erro %}
                            <div class="bg-red-100 text-red-600 text-xs p-2 rounded mb-3 border border-red-200">
                                {{ erro }}
                            </div>
                        {% endif %}

                        <form method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="acao" value="identificar">
                            <input type="text" name="cpf_login" placeholder="000.000.000-00" required 
                                   class="w-full p-3 border border-gray-300 rounded-lg text-sm mb-4 text-center tracking-widest focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all">
                            
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg text-sm transition-colors shadow-lg shadow-blue-600/30">
                                Iniciar Conversa
                            </button>
                        </form>
                    </div>
                </div>
                {% endif %}

                {% if step == 2 %}
                <div id="screen-form" class="absolute inset-0 p-6 flex flex-col fade-in z-10 bg-gray-50">
                    <div class="bg-blue-50 border border-blue-100 p-3 rounded-lg mb-4 shrink-0">
                        <p class="text-xs text-blue-800"><i class="fa-solid fa-user-check mr-1"></i> OlÃ¡, <strong>{{ cliente.nome }}</strong></p>
                    </div>

                    <form id="ticketForm" class="flex-1 flex flex-col">
                        {% csrf_token %}
                        <input type="hidden" name="acao" value="abrir_chamado">
                        <input type="hidden" name="cliente_id" value="{{ cliente.id }}">
                        
                        <label class="block text-xs font-bold text-gray-500 mb-1">Sobre o que vamos falar?</label>
                        <select name="assunto" class="w-full p-3 border border-gray-300 rounded-lg text-sm mb-4 bg-white focus:border-blue-500 outline-none">
                            <option value="Sem Internet">ðŸ”´ Estou sem internet</option>
                            <option value="LentidÃ£o">ðŸŸ¡ Internet lenta</option>
                            <option value="Financeiro">ðŸ“„ Boleto / Financeiro</option>
                            <option value="Outros">ðŸ”µ Outros assuntos</option>
                        </select>

                        <label class="block text-xs font-bold text-gray-500 mb-1">Mensagem</label>
                        <textarea id="msgInput" name="mensagem" required placeholder="Descreva o que estÃ¡ acontecendo..." 
                                  class="w-full p-3 border border-gray-300 rounded-lg text-sm mb-4 resize-none bg-white flex-1 focus:border-blue-500 outline-none"></textarea>

                        <button type="submit" id="btnEnviar" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-sm transition-colors flex justify-center items-center gap-2 shadow-lg shadow-green-600/30">
                            <i class="fa-solid fa-paper-plane"></i> Enviar SolicitaÃ§Ã£o
                        </button>
                    </form>
                </div>

                <div id="screen-success" class="absolute inset-0 bg-white z-20 flex flex-col items-center justify-center p-6 hidden-force fade-in">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center text-green-500 text-4xl mb-4 animate-bounce">
                        <i class="fa-solid fa-check"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Recebido!</h3>
                    <p class="text-gray-500 text-sm text-center mb-6">Seu ticket foi criado com sucesso.</p>
                    
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 w-full mb-6 text-center">
                        <span class="text-xs text-gray-400 uppercase font-bold">Protocolo</span>
                        <div id="protocolo-display" class="text-2xl font-mono font-bold text-gray-800 tracking-wider">#---</div>
                    </div>

                    <button onclick="goToChat()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg text-sm transition-colors flex justify-center items-center gap-2">
                        <i class="fa-solid fa-comments"></i> Continuar com Atendente
                    </button>
                </div>

                <div id="screen-chat" class="absolute inset-0 bg-[#e5ddd5] z-30 flex flex-col hidden-force slide-in">
                    <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-3" style="background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); opacity: 0.9;">
                        
                        <div class="flex justify-center my-4">
                            <span class="bg-blue-100 text-blue-800 text-[10px] px-2 py-1 rounded shadow">
                                Hoje
                            </span>
                        </div>

                        </div>

                    <div class="bg-white p-2 flex items-center gap-2 border-t border-gray-200">
                        <button class="text-gray-400 p-2"><i class="fa-solid fa-plus"></i></button>
                        <input type="text" placeholder="Aguarde um atendente..." disabled class="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm focus:outline-none">
                        <button class="text-blue-500 p-2"><i class="fa-solid fa-microphone"></i></button>
                    </div>
                </div>

                {% endif %}
            </div>
        </div>

        <button onclick="toggleChat()" class="w-16 h-16 bg-blue-600 rounded-full shadow-2xl flex items-center justify-center text-white text-3xl hover:scale-110 transition-transform hover:bg-blue-500 border-4 border-white">
            <i class="fa-solid fa-comment-dots"></i>
        </button>

    </div>

    <script>
        let ticketId = null; // Guarda o ID do ticket aberto
        let lastMessageId = 0; // Para saber quais mensagens sÃ£o novas

        function toggleChat() {
            const chat = document.getElementById('chat-window');
            if (chat.style.display === 'none' || chat.classList.contains('hidden-force')) {
                chat.style.display = 'flex';
                chat.classList.remove('hidden-force');
            } else {
                chat.style.display = 'none';
            }
        }

        const form = document.getElementById('ticketForm');
        
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const btn = document.getElementById('btnEnviar');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';

                // Salva msg visualmente
                window.userMessageTemp = document.getElementById('msgInput').value;

                const formData = new FormData(form);
                fetch('', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        ticketId = data.ticket_id; // SALVA O ID DO TICKET
                        document.getElementById('screen-form').classList.add('hidden-force');
                        document.getElementById('screen-success').classList.remove('hidden-force');
                        document.getElementById('protocolo-display').innerText = '#' + ticketId;
                    } else {
                        alert('Erro ao enviar.');
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                });
            });
        }

        function goToChat() {
            document.getElementById('screen-success').classList.add('hidden-force');
            document.getElementById('screen-chat').classList.remove('hidden-force');

            const chatArea = document.getElementById('chat-messages');
            
            // Adiciona a primeira mensagem do usuÃ¡rio visualmente
            chatArea.innerHTML += `
                <div class="flex justify-end fade-in">
                    <div class="bg-[#dcf8c6] text-gray-800 p-2 rounded-lg rounded-tr-none shadow max-w-[80%] text-sm">
                        ${window.userMessageTemp}
                        <div class="text-[10px] text-gray-500 text-right mt-1"><i class="fa-solid fa-check"></i></div>
                    </div>
                </div>
            `;

            // INICIA O POLLING (Busca novas mensagens a cada 3 segundos)
            setInterval(buscarNovasMensagens, 3000);
        }

        function buscarNovasMensagens() {
            if (!ticketId) return;

            // VocÃª precisarÃ¡ criar essa rota no Django ou usar uma existente
            // Exemplo: /api/chamados/123/comentarios/
            fetch(`/api/chamados/${ticketId}/comentarios/`) 
            .then(r => r.json())
            .then(msgs => {
                const chatArea = document.getElementById('chat-messages');
                let scrollNeeded = false;

                msgs.forEach(msg => {
                    // Se for mensagem NOVA e NÃƒO for do prÃ³prio cliente (via site)
                    if (msg.id > lastMessageId) {
                        lastMessageId = msg.id;
                        
                        // Se for mensagem do AGENTE (Staff)
                        if (msg.is_staff) { 
                            const bubble = `
                                <div class="flex justify-start fade-in mb-3">
                                    <div class="bg-white text-gray-800 p-2 rounded-lg rounded-tl-none shadow max-w-[80%] text-sm">
                                        <strong>${msg.autor}:</strong><br>
                                        ${msg.texto}
                                        <div class="text-[10px] text-gray-400 text-right mt-1">${msg.hora}</div>
                                    </div>
                                </div>
                            `;
                            chatArea.innerHTML += bubble;
                            scrollNeeded = true;
                        }
                    }
                });

                if (scrollNeeded) chatArea.scrollTop = chatArea.scrollHeight;
            });
        }
    </script>

</body>
</html>